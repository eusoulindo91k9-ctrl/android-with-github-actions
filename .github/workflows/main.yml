name: Android Web Host Otimizado
on: 
  workflow_dispatch:

jobs:
  run-emulator:
    runs-on: ubuntu-latest
    steps:
      - name: Liberar EspaÃ§o e Habilitar KVM
        run: |
          # AceleraÃ§Ã£o de Hardware Ã© essencial para nÃ£o demorar horas
          sudo apt-get update
          sudo apt-get install -y qemu-kvm
          sudo chmod 666 /dev/kvm

      - name: Iniciar Android 10 (VersÃ£o Otimizada)
        run: |
          # Usando a imagem do budtmo que Ã© a mais estÃ¡vel para Web
          # Configuramos 2 CPUs e 4GB de RAM (limite do GitHub)
          docker run -d -p 6080:6080 -p 5554:5554 -p 5555:5555 \
            --device /dev/kvm \
            --name android_container \
            -e EMULATOR_DEVICE="Samsung Galaxy S10" \
            -e WEB_VNC=true \
            -e CORE=2 \
            -e RAM=4096 \
            budtmo/docker-android:emulator_10.0

      - name: Instalar Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Aguardar InicializaÃ§Ã£o do Site
        run: |
          echo "Aguardando o sistema preparar a interface web (Porta 6080)..."
          # Verifica se a porta 6080 responde. Isso evita o erro 3004 do Ngrok.
          timeout 300s bash -c 'until curl -s localhost:6080 > /dev/null; do sleep 5; done'
          echo "Interface Web detectada!"

      - name: Abrir TÃºnel e Enviar Link
        run: |
          # Abre o tÃºnel
          ngrok http 6080 --log=stdout > /dev/null &
          sleep 10
          
          # Pega a URL
          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          # Calcula o Ping do servidor para vocÃª ter uma base
          PING_MS=$(ping -c 3 8.8.8.8 | tail -1 | awk '{print $4}' | cut -d '/' -f 2)
          
          echo "------------------------------------------------"
          echo "ðŸ“± ANDROID 10 ONLINE"
          echo "ðŸ”— LINK: $URL"
          echo "âš¡ PING DO SERVIDOR: ${PING_MS}ms"
          echo "------------------------------------------------"
          
          if [ ! -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\": \"ðŸš€ **Android 10 Online!**\nðŸ”— Link: $URL\nâš¡ Ping Servidor: ${PING_MS}ms\n\n*Nota: O primeiro boot demora uns 3-5 min atÃ© a tela sair do logo Android.*\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Manter Ativo
        run: |
          # MantÃ©m o log atualizando com o ping para a Action nÃ£o fechar por inatividade
          while true; do
            echo "Mantendo conexÃ£o ativa... Ping atual: $(ping -c 1 google.com | grep 'time=' | awk '{print $7}')"
            sleep 60
          done
