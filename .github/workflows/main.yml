name: Android 10 Ultra Fast
on: 
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: Preparar Kernel para Android (BinderFS)
        run: |
          # Em vez de modprobe, usamos o binderfs que jÃ¡ vem no kernel 6.x
          sudo mkdir -p /dev/binderfs
          sudo mount -t binder binder /dev/binderfs
          
          # Criar links para o Redroid encontrar os drivers
          sudo ln -s /dev/binderfs/binder /dev/binder
          sudo ln -s /dev/binderfs/hwbinder /dev/hwbinder
          sudo ln -s /dev/binderfs/vndbinder /dev/vndbinder
          sudo chmod 777 /dev/binder /dev/hwbinder /dev/vndbinder

      - name: Iniciar Redroid (Android 10)
        run: |
          # Rodando em modo privilegiado para ter performance total
          docker run -d --privileged \
            --name redroid \
            -v ~/data:/data \
            -p 5555:5555 \
            redroid/redroid:10.0.0-latest \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_dpi=320 \
            androidboot.redroid_fps=30

      - name: Iniciar Interface Web (scrcpy-web)
        run: |
          # Este container cria o site para vocÃª mexer no Android
          docker run -d \
            --name scrcpy-web \
            --link redroid:listentarget \
            -p 8000:8000 \
            -e ADB_SERVER_IP=listentarget \
            empof/ws-scrcpy

      - name: Instalar e Configurar Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Aguardar Android e Abrir TÃºnel
        run: |
          # Aguarda o serviÃ§o web estar pronto para evitar o erro 3004 do Ngrok
          echo "Aguardando inicializaÃ§Ã£o do sistema..."
          sleep 20
          
          # Inicia o Ngrok na porta do site (8000)
          ngrok http 8000 --log=stdout > /dev/null &
          sleep 10
          
          # Captura a URL pÃºblica
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "---------------------------------------------------"
          echo "ðŸ“± ANDROID 10 PRONTO PARA USO!"
          echo "ðŸ”— LINK: $NGROK_URL"
          echo "---------------------------------------------------"
          
          if [ ! -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\": \"ðŸš€ **Android 10 Online!**\nðŸ”— Link: $NGROK_URL\nâš¡ Performance: Redroid Otimizado\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Manter Vivo e Mostrar Ping
        run: |
          # Loop para mostrar que estÃ¡ vivo e monitorar o ping
          while true; do
            echo "Status: Online | Ping Google: $(ping -c 1 8.8.8.8 | grep 'time=' | awk '{print $7}')"
            sleep 60
          done
