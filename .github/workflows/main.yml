name: Android 10 Ultra Fast
on: 
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar Depend√™ncias e KVM
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          # Carregar m√≥dulos necess√°rios para o Redroid
          sudo modprobe binder_linux devices="binder,hwbinder,vndbinder"
          sudo modprobe ashmem_linux

      - name: Iniciar Redroid (Android 10)
        run: |
          # Redroid √© muito mais leve que o emulador comum
          docker run -d --privileged \
            --name redroid \
            -v ~/data:/data \
            -p 5555:5555 \
            redroid/redroid:10.0.0-latest \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_dpi=320

      - name: Iniciar Interface Web (scrcpy-web)
        run: |
          # Isso cria o site para voc√™ mexer no Android pelo navegador
          docker run -d \
            --name scrcpy-web \
            --link redroid:listentarget \
            -p 8000:8000 \
            -e ADB_SERVER_IP=listentarget \
            -e CONNECTION_TIMEOUT=600000 \
            empof/ws-scrcpy

      - name: Configurar Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Abrir T√∫nel e Mostrar Link
        run: |
          # Abre o t√∫nel na porta 8000 (interface web)
          ngrok http 8000 --log=stdout > /dev/null &
          sleep 15
          
          # Pega a URL
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "------------------------------------------------------------------"
          echo "üì± ANDROID 10 EST√Å PRONTO!"
          echo "üîó ACESSE O SITE: $NGROK_URL"
          echo "------------------------------------------------------------------"
          
          # Enviar para o Discord se configurado
          if [ ! -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\": \"üöÄ **Android 10 Online!**\nO sistema j√° deu boot.\nüîó Link: $NGROK_URL\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Manter Execu√ß√£o
        run: |
          echo "Ping do Servidor: $(ping -c 1 google.com | grep 'time=')"
          # Mant√©m vivo por 6 horas
          sleep 21600
